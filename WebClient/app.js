(function(){function C(a,b,c){function d(a,b){if(!a)return null;var c="",f=null;if(a.childNodes&&0<a.childNodes.length)for(var e=0;e<a.childNodes.length;e++){var l=a.childNodes[e],m=l.nodeType,g=l.localName||l.nodeName||"",k=l.text||l.nodeValue||"";if(8!=m)if(3==m||4==m||!g)c+=k.replace(/^\s+|\s+$/g,"");else if(f=f||{},f[g]){if(!(f[g]instanceof Array)||!f[g].length)f[g]=[f[g]];f[g].push(d(l,!0))}else f[g]=d(l,!1)}if(a.attributes&&!i&&0<a.attributes.length){f=f||{};for(l=0;l<a.attributes.length;l++)g=
a.attributes[l],m=g.name||"",g=g.value,f[m]?(!(f[m]instanceof Array)&&f[m].length&&(f[m]=[f[m]]),f[m].push(g)):f[m]=g}if(f){if(""!=c){l=new String(c);for(e in f)l[e]=f[e];f=l}if(c=f.text?("object"==typeof f.text?f.text:[f.text||""]).concat([c]):c)f.text=c;c=""}f=f||c;if(h){c&&(f={});if(c=f.text||c||"")f.text=c;!b&&!(f instanceof Array)&&(f=[f])}return f}var h=b,i=c;if(!a)return{};"string"==typeof a&&(a=E(a));if(a.nodeType){if(3==a.nodeType||4==a.nodeType)return a.nodeValue;a=9==a.nodeType?a.documentElement:
a;b=d(a,!0);a=a=null;return b}}function E(a){var b;try{var c=new DOMParser;c.async=!1;b=c.parseFromString(a,"text/xml")}catch(d){throw Error("Error parsing XML string");}return b}function u(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;a=8*a.length;b[a>>5]|=128<<24-a%32;b[(a+64>>9<<4)+15]=a;for(var a=Array(80),c=1732584193,d=-271733879,h=-1732584194,i=271733878,j=-1009589776,e=0;e<b.length;e+=16){for(var D=c,f=d,n=h,l=i,m=j,g=0;80>g;g++){a[g]=16>g?b[e+g]:(a[g-3]^
a[g-8]^a[g-14]^a[g-16])<<1|(a[g-3]^a[g-8]^a[g-14]^a[g-16])>>>31;var o=k(k(c<<5|c>>>27,20>g?d&h|~d&i:40>g?d^h^i:60>g?d&h|d&i|h&i:d^h^i),k(k(j,a[g]),20>g?1518500249:40>g?1859775393:60>g?-1894007588:-899497514)),j=i,i=h,h=d<<30|d>>>2,d=c,c=o}c=k(c,D);d=k(d,f);h=k(h,n);i=k(i,l);j=k(j,m)}b=[c,d,h,i,j];a="";for(c=0;c<4*b.length;c++)a+="0123456789abcdef".charAt(b[c>>2]>>8*(3-c%4)+4&15)+"0123456789abcdef".charAt(b[c>>2]>>8*(3-c%4)&15);return a}function k(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+
(c>>16)<<16|c&65535}var r,n,s,e,v,t,w,o,x,y,z,A,B,p=function(a,b){return function(){return a.apply(b,arguments)}};window.offline_mode=!navigator.onLine;window.app={back:function(){return history.go(-1)},autologin:"on"===$("#autologin").val(),offline:function(){return!navigator.onLine}};setTimeout(function(){if(window.offline_mode&&navigator.onLine)return confirm("You are online now, \npress OK to reload the App and enable online features!")?location.reload():setTimeout(arguments.callee,6E4)},1E4);
app.offline()&&$(document.body).addClass("offline");o=function(a,b){if(null!=a.svc&&null==b)b=a,a=b.svc;else if("string"===typeof a)b.svc=a;b.type=null!=b.type&&/get/i.test(b.type)?"GET":"POST";if("POST"===b.type)b.data=JSON.stringify(b.data);if(b.nowait)b.background=!0;b.background||$.mobile.showPageLoadingMsg();$.ajax({url:"svc/"+b.svc+".svc/"+b.method,type:b.type,dataType:"json",contentType:"application/json;charset=utf-8",data:b.data,processdata:"POST"!==b.type,complete:b.background?null:function(){$.mobile.hidePageLoadingMsg();
return"function"===typeof b.complete?b.complete():void 0},success:b.nowait?null:function(a,d,h){if(null!=a&&"d"in a)return"function"===typeof b.callback?b.callback(a.d):void 0;alert("Network Error");return console.log("err",h,h.statusText)},error:function(a){alert("Network Error");return console.log("err",a,a.statusText)}});return!1};n={fmt:function(a){return 9<a?a.toString():"0"+a},dateToWcf:function(a){var b;b=(new Date).getTimezoneOffset()/60;return"/Date("+ +(Date.parse(a)-36E5*b)+(0<b?"-":"+")+
(9<b?"":"0")+b+"00)/"},dateFromWcf:function(a){a=a.match(/^\/Date\((\d+)([+-]\d{2})(\d{2})\)\/$/);return 4!==a.length?null:new Date(Number(a[1])-36E5*Number(a[2]))},dateToStr:function(a){a=new Date(a);return""+a.getFullYear()+"-"+this.fmt(a.getMonth()+1)+"-"+this.fmt(a.getDate())+" "+this.fmt(a.getHours())+":"+this.fmt(a.getMinutes())+":"+this.fmt(a.getSeconds())},dateFromWcfToStr:function(a){return this.dateToStr(this.dateFromWcf(a))},dateToUTC:function(a){a=new Date(a);return""+a.getUTCFullYear()+
"-"+this.fmt(a.getUTCMonth()+1)+"-"+this.fmt(a.getUTCDate())+"T"+this.fmt(a.getUTCHours())+":"+this.fmt(a.getUTCMinutes())+":"+this.fmt(a.getUTCSeconds())}};try{app.user=JSON.parse(sessionStorage.user||localStorage.user),0<(null!=(z=app.user)?z.uid:void 0)&&32===(null!=(A=app.user)?null!=(B=A.sid)?B.length:void 0:void 0)?(location.hash="#home",o("user",{method:"check",data:{uid:app.user.uid,sid:app.user.sid},callback:function(a){console.log("check",a);a||$.mobile.changePage("#login",{transition:"none"});
return null}})):location.hash="#login"}catch(F){app.user=null,location.hash="#login"}console.log("app.user",app.user);app.save_profile=window.onbeforeunload=function(){var a;if(null!=(a=app.user)&&a.uid){if(a=sessionStorage.user=JSON.stringify(app.user),app.autologin)localStorage.user=a}else localStorage.removeItem("user"),sessionStorage.removeItem("user")};$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();
r=document.body;v=$(document.querySelectorAll('[data-role="map"]'));$(window).resize(function(){app.horizontal=r.clientWidth>r.clientHeight;return $(r)[app.horizontal?"addClass":"removeClass"]("horizontal")});$(document.body).resize();e=app.map=null;if(!app.offline())$("#home").one({pageshow:function(){return e.el.offset($("#home_map").offset())}}),e=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}}),
e.plcsvc=new google.maps.places.PlacesService(e),e.geocoder=new google.maps.Geocoder,e.dirsvc=new google.maps.DirectionsService,e.dirrdr=new google.maps.DirectionsRenderer,e.svbounds=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,-122.728271),new google.maps.LatLng(37.247821,-121.552734)),function(){this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{setMarkers:p(function(a){console.log("markers",a);a?$.isArray(a)||(a=[a]):a=null;null!=this.markers&&
this.markers.forEach(function(a){return a.setMap(null)});this.markers=null!=a?a.map(function(a){a.map=e;return new google.maps.Marker(a)}):null;return this},this),getCurPos:p(function(a,b){null==b&&(b=a,a=!0);app.offline()?b.call(this,null,null):null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(p(function(c){var d;d=new google.maps.LatLng(c.coords.latitude,c.coords.longitude);console.log("curlatlng",d);if(!d.equals(this.getCenter()))d.changed=!0;return a&&d.changed?(this.setMarkers(null),
this.setCenter(d),v.each(p(function(a,c){return $(c).css("background-image","url('//maps.googleapis.com/maps/api/staticmap?center="+d.lat()+","+d.lng()+"&zoom="+($(c).attr("data-map-zoom")||15)+"&size="+$(window).width()+"x"+this.el.height()+"&maptype=roadmap&format=png8&sensor=true&language=en')")},this)),e.geocoder.geocode({latLng:d},p(function(a,c){var j;c===google.maps.GeocoderStatus.OK?b.call(this,d,null!=(j=a[0])?j.formatted_address:void 0):alert("Geocoder failed due to: "+c+"\n App terminated!");
return this.setCenter(d)},this))):b.call(this,d)},this),function(){return alert("App cannot run without geo location!")});return this},this)})}.call(e),$('[data-role="page"]').bind({pagebeforeshow:function(){e.el.addClass("hidden");return $(document.body)[app.offline()?"addClass":"removeClass"]("offline")},pageshow:function(){var a,b;$.mobile.fixedToolbars.show();this.hh=(null!=(a=$('[data-role="header"]',this))?a.outerHeight():void 0)||0;this.fh=(null!=(b=$('[data-role="footer"]',this))?b.outerHeight():
void 0)||0;this.bh=document.body.clientHeight-this.hh-this.fh;$(".map",this).add(e.el).height(this.bh*(app.horizontal?1:0.45));if($(this).hasClass("has-map"))return e.el.removeClass("hidden")}});app.sync_weather=function(){var a;a=function(a){var c,d;null!=(null!=(c=a.weather)?c.current_conditions:void 0)?(c=a.weather.current_conditions,console.log("w:",a),d=function(a){return"//www.google.com"+a.icon.data},c=$("#weather").html('<div id="weather_now" class="weather"><img src="'+d(c)+'"/>'+c.condition.data+
"<br/>"+c.temp_f.data+"\u00b0F</div>"),c.append(a.weather.forecast_conditions.map(function(a){return'<div class="weather"><img src="'+d(a)+'"/>'+a.day_of_week.data+" "+a.high.data+"/"+a.low.data+"\u00b0F</div>"}).join(""))):$("#weather").html("(No Weather Data)");return this};return app.offline()?null!=localStorage.weather?a(JSON.parse(localStorage.weather)):a(null):$.ajax({url:"gapi?&hl=en-us&weather=san+jose,ca",dataType:"xml",success:function(b){b=C(b);localStorage.weather=JSON.stringify(b);return a(b)},
error:function(a){return console.log("get weather failed",a)}})};s=function(a,b){return u("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+u("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+"\u00ff"+b+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")+b+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")};
if(null!=window.openDatabase)app.db=openDatabase("KnightRider","1.0","Data cache for Knight Rider",2E5),null!=app.db?(app.db._onerr=function(a,b){return console.error("local db error",a,b)},app.db.sync=function(a,b){console.log("sync",a);a=a.toLowerCase();app.db.transaction(function(c){return c.executeSql("SELECT modified FROM ["+a+"] WHERE id=0",[],function(c,h){var e;e=h.rows.item(0);console.log("last",a,e);return o(a,{method:"sync",type:"get",background:!0,data:{last:n.dateToStr(e.modified)},callback:function(c){console.log("sync",
a,c);return"function"===typeof b?b(c):void 0}})})});return this},y=function(){return app.offline()?void 0:app.db.sync("place",function(a){if(a.length)return app.db.transaction(function(b){var c,d;c=a.map(function(a){return a.id});d=a.map(function(a){return[a.id,a.gid,a.name,a.location.lat,a.location.lng,a.vicinity,a.fulladdr,a.phone,a.website,a.rating,a.gtypes,a.svctypes,a.status,n.dateFromWcfToStr(a.created),n.dateFromWcfToStr(a.modified)]});console.log("db","INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,website,rating,gtypes,svctypes,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
d);b.executeSql("DELETE FROM [Place] WHERE id IN ("+c.join(",")+")");d.forEach(function(a){return b.executeSql("INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,website,rating,gtypes,svctypes,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",a,null,app.db._onerr)});return b.executeSql("UPDATE [Place] SET modified=DATETIME('now') WHERE id=0")})})},x=function(a){var b;b=function(c){return c.executeSql("SELECT * FROM [Alerts] WHERE status=1 and expired > DATETIME('now') ORDER BY datetime DESC, importance DESC;",
[],function(c,b){var e,j,q;console.log("alerts count",b.rows.length);q=[];for(e=b.rows.length;e;)j=$.extend({},b.rows.item(--e)),j.datetime=new Date(j.datetime),j.expired=new Date(j.expired),j.created=new Date(j.created),j.modified=new Date(j.modified),q.unshift(j);console.log("alerts from db",q,b);return"function"===typeof a?a(q,"alerts"):void 0},app.db._onerr)};app.offline()?app.db.transaction(b):app.db.sync("alerts",function(a){app.db.transaction(function(d){var e,i;a.length&&(e=a.map(function(a){return a.id}),
i=a.map(function(a){return[a.id,a.summary,a.message,n.dateFromWcfToStr(a.datetime),n.dateFromWcfToStr(a.expired),a.importance,a.type,a.status,n.dateFromWcfToStr(a.created),n.dateFromWcfToStr(a.modified)]}),console.log("db","INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",i),d.executeSql("DELETE FROM [Alerts] WHERE id IN ("+e.join(",")+")"),i.forEach(function(a){return d.executeSql("INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",
a)}),d.executeSql("UPDATE [Alerts] SET modified=DATETIME('now') WHERE id=0"));b(d);return this});return this});return this},app.db.sync_all=function(a){console.log("sync all");y();return x(a)},app.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS [Alerts] (\t\t\t\tid int not null primary key, \t\t\t\tsummary nvarchar(100) not null, \t\t\t\tmessage text, \t\t\t\tdatetime datetime, \t\t\t\texpired datetime, \t\t\t\timportance tinyint not null, \t\t\t\ttype tinyint not null, \t\t\t\tstatus tinyint not null,\t\t\t\tcreated datetime DEFAULT CURRENT_TIMESTAMP, \t\t\t\tmodified datetime not null\t\t\t);");
a.executeSql("CREATE INDEX IF NOT EXISTS [Alerts_ODR] ON [Alerts] (datetime DESC, importance DESC);");a.executeSql("INSERT INTO [Alerts](id,summary,importance,type,status,modified) SELECT 0,'LastUpdate',0,0,0,DATETIME(0,'unixepoch') WHERE NOT EXISTS(SELECT * FROM [Alerts] WHERE id=0);");a.executeSql("CREATE TABLE IF NOT EXISTS [Place] (\t\t\t\tid int not null primary key, \t\t\t\tgid char(40),\t\t\t\tname nvarchar(100),\t\t\t\tlat float,\t\t\t\tlng float,\t\t\t\tvicinity nvarchar(200),\t\t\t\tfulladdr nvarchar(1000),\t\t\t\tphone varchar(15),\t\t\t\twebsite varchar(100),\t\t\t\trating tinyint,\t\t\t\tgtypes varchar(100),\t\t\t\tsvctypes tinyint not null,\t\t\t\tstatus tinyint not null,\t\t\t\tcreated datetime DEFAULT CURRENT_TIMESTAMP,\t\t\t\tmodified datetime not null\t\t\t);");
a.executeSql("CREATE INDEX IF NOT EXISTS [Place_GID] ON [Place] (GID);");a.executeSql("CREATE INDEX IF NOT EXISTS [Place_TYP] ON [Place] (svctypes);");return a.executeSql("INSERT INTO [Place](id,name,svctypes,status,modified) SELECT 0,'LastUpdate',0,0,DATETIME(0,'unixepoch') WHERE NOT EXISTS(SELECT * FROM [Place] WHERE id=0);")})):alert("open db err");$("#home").bind({pagecreate:function(){return this.created=!0},pagebeforeshow:function(){console.log("home pageshow");app.offline()?$("#home_addr").text("You are offline now"):
window.offline_mode||e.getCurPos(function(a,b){null!=b&&$("#home_addr").text(b);this.setZoom(15);return this.setMarkers({position:a})});app.sync_weather();app.db.sync_all(function(a,b){var c;if("alerts"===b)return $("#alerts").empty(),c='<li data-role="list-divider" class="ui-body-c list-none">No Alerts</li>',0<a.length&&(c='<li data-role="list-divider" class="ui-body-c list-none">'+a.length+" Alerts</li>"+a.map(function(a){return"<li><a href=\"javascript:alert('Summary: "+a.summary+"\\nMessage: "+
a.message+"\\nFrom: "+a.datetime+"\\nExpire: "+a.expired+"')\">"+a.summary+" ("+a.datetime.toLocaleDateString()+")</a></li>"}).join("")),$("#alerts").html(c).listview().listview("refresh")});return this},pageshow:function(){var a;a=$("#alerts");return a.height(document.body.clientHeight-a.offset().top-this.fh)}});$("#login").bind({pagecreate:function(){$("#login_form").submit(function(a){var b,c,d,e,i;a.preventDefault();a.stopPropagation();if(app.offline())return!1;d=$("input",this).textinput("disable");
i=$("select",this).slider("disable");b=$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");c=$("#email").val().trim();a=$("#password").val();if(!c||!a)return!1;e=s(c.toLowerCase(),a);app.autologin="on"===$("#autologin").val();o("user",{method:"login",data:{email:c,password:e},callback:function(a){var b;console.log(a);return a.uid&&32===(null!=(b=a.sid)?b.length:void 0)?(app.user={uid:a.uid,email:c,sid:a.sid,psw:s(a.sid+a.uid+e)},$.mobile.changePage("#home",{transition:"flip"})):
alert("Login Failed, please try again")},complete:function(){b.button("enable");d.textinput("enable");i.slider("enable");return $("#btn_reg").removeClass("ui-disabled")}});return!1});return this},pagebeforehide:function(){return $("#login_form_warp").hide()},pagebeforeshow:function(){return $("#login_form_warp").hide()},pageshow:function(){$("#password").val("");$("#login_form_warp").show();console.log("logout",app.user);if(navigator.onLine){$("button",this).button("enable");$("#btn_reg").removeClass("ui-disabled");
if(null==app.user)return;o("user",{method:"logout",nowait:!0,data:{uid:app.user.uid,sid:app.user.sid}});app.user=null;app.save_profile()}else $("button",this).button("disable"),$("#btn_reg").addClass("ui-disabled"),app.offline()&&alert("You are offline now!\nLogin need a network.");return this}});$("#reg_form").submit(function(a){var b,c;a.preventDefault();a.stopPropagation();if(app.offline())return!1;if(this.password.value!==this.password2.value)return alert("Password does not match!"),this.password2.focus(),
!1;a=this.email.value.trim();b=this.password.value;b=s(a.toLowerCase(),b);c={email:a,password:b,fullname:{first:this.first.value.trim(),last:this.last.value.trim()},phone:this.phone.value.trim()};console.log("reg",c);o("user",{method:"reg",data:{user:c},callback:function(a){console.log("new id:",a);if(1>a)return alert("Email already exists!");$("#email").val(c.email);$("#reg").dialog("close");return alert("Registration successful!")}});return!1});$("#appointment").bind({pagebeforeshow:function(){var a,
b;if(app.offline())return app.back();$("#datetime").val(Date((new Date).getTime()+36E5).toLocaleString());32!==(null!=(a=app.user)?null!=(b=a.sid)?b.length:void 0:void 0)&&$.mobile.changePage("#login",{transition:"flip",reverse:!0});return!1}});$("#appt_form").submit(function(a){var b,c,d;if(32!==(null!=(b=app.user)?null!=(c=b.sid)?c.length:void 0:void 0)||0===(null!=(d=app.user)?d.uid:void 0)||app.offline())return!1;a.preventDefault();a.stopPropagation();a={user:app.user.uid,place:app.selected_place.id,
contact:{name:this.name.value,phone:this.phone.value},datetime:n.dateToWcf(this.datetime.value),message:this.comments.value};console.log("appt",a);o("appointment",{method:"add",data:{appt:a,sid:app.user.sid},callback:function(a){console.log("appt success:",a);return a?($("#appointment").dialog("close"),alert("Appointment sent successful!")):$.mobile.changePage("#login",{transition:"flip",reverse:!0})}});return!1});$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=$(this).text();
console.log("vclick",app.search_keyword);return this}});app.custom_search_history_refresh=function(){var a,b;$("#custom_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if(null!=(b=app.user.custom_search_history)&&b.length)a=app.user.custom_search_history.map(function(a){return'<li><a href="#result" data-btn-role="search">'+a+"</a></li>"}).join("");return $("#custom_history_list_header").after(a)};app.place_search_history_refresh=function(){var a,
b;$("#search_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if(null!=(b=app.user.place_search_history)&&b.length)a=app.user.place_search_history.map(function(a,b){return'<li><a href="#detail" data-btn-role="result" data-index="'+b+'"><img src="'+a.icon+'" class="ui-li-icon"><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("");return $("#search_history_list_header").after(a)};$("#custom_search").bind({pagecreate:function(){this.created=
!0;app.custom_search_history_refresh();if(!app.offline())return new google.maps.places.Autocomplete($("#input_search")[0],{bounds:e.svbounds,types:["establishment"]})}});$("#custom_search").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#custom_history_list").listview("refresh")});$("#custom_search_form").submit(function(){var a,b;a=$("#input_search");(b=$.trim(a.val()))?(app.search_keyword=new String(b),app.search_keyword.custom=!0,$.mobile.changePage("#result"),console.log("vclick",
app.search_keyword)):a.focus().val("");return!1});$("#search_history").bind({pagecreate:function(){this.created=!0;app.place_search_history_refresh();return $("#search_history li a").live({vclick:function(){return app.selected_place=app.user.place_search_history[Number($(this).attr("data-index"))]}})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#search_history_list").listview("refresh")});t={"Service Station":2,"Gas Station":4,"Towing Station":8,"Vehicle Repair Station":16};
$("#result").bind({pagebeforeshow:function(){var a;console.log("search for",app.search_keyword);if(app.search_keyword)return $.mobile.showPageLoadingMsg(),a=$("#result_list").empty(),app.offline()?$("#result_addr").text("You are offline now"):e.getCurPos(function(b){this.setZoom(12);return e.plcsvc.search({location:b,radius:5E3,keyword:app.search_keyword},function(c,d){var h,i,j,k;if(d===google.maps.places.PlacesServiceStatus.ZERO_RESULTS)alert("Zero Result"),app.back();else if(d===google.maps.places.PlacesServiceStatus.OK){if($("#result_addr").text(""+
app.search_keyword+" ("+c.length+")"),a.height(document.body.clientHeight-a.offset().top),console.log("search result",c),i=null!=localStorage.places?JSON.parse(localStorage.places):{},c.forEach(function(a){return null!=i[a.id]?i[a.reference]|=t[app.search_keyword]:i[a.reference]=t[app.search_keyword]}),localStorage.places=JSON.stringify(i),app.result_map={},c.forEach(function(a){var c,d;app.result_map[a.id]=a;a=a.geometry;d=a.location.lng()-b.lng();c=a.location.lat()-b.lat();return a.dist=Math.pow(d,
2)+Math.pow(c,2)}),c.sort(function(a,c){return a.geometry.dist-c.geometry.dist}),c=c.slice(0,25),a.append(c.map(function(a,c){var b;a.seq=String.fromCharCode(65+c);return'<li><a href="#detail" data-btn-role="result" id="'+a.id+'"><div style="float:left">'+a.seq+'</div><img src="'+(null!=(b=a.icon)?b.replace(/^http:/,""):void 0)+'" class="ui-li-icon"><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("")),h=c.reverse().map(function(a){return{position:a.geometry.location,
icon:"//www.google.com/mapfiles/marker"+a.seq+".png",title:a.name}}),a.listview("refresh"),h.push({position:b,icon:"//www.google.com/mapfiles/arrow.png",title:"You are here"}),e.setMarkers(h),app.search_keyword.custom&&(h=null!=(k=(j=app.user).custom_search_history)?k:j.custom_search_history=[],0===h.length||h[0]!==app.search_keyword))h.unshift(app.search_keyword),app.custom_search_history_refresh()}else alert("Search Error");return this})}),this;app.back()}});w=function(a){var b,c,a=Number(a);c=
a.toFixed(1);b=a|0;0<b&&(c+=" "+Array(b+1).join('<img src="res/star.png"/>'));0.4<a-b&&(c+='<img src="res/halfstar.png"/>');return c};$("#result_list a").live({vclick:function(){console.log(this.id);return app.selected_place=app.result_map[this.id]}});$("#detail").bind({pagecreate:function(){return $("#apt_cancel").bind({vclick:function(a){a.preventDefault();a.stopPropagation();$("#appointment").dialog("close");return!1}})},pageshow:function(){var a,b;a=$("#detial_info");a.height(document.body.clientHeight-
a.offset().top-this.fh);console.log("detailof",app.selected_place);window.scrollTop=0;if(app.selected_place)return $('[data-role="navbar"] a',this)[app.offline()?"addClass":"removeClass"]("ui-disabled"),b=function(c){var b,h,i,j,k;e.setCenter(c.geometry.location);e.setMarkers({position:c.geometry.location});e.setZoom(15);$("#detail_place").text(c.name);b="Visit its Website";if(null!=c.website){if(/^place:\d+/.test(c.website))c.website=c.website.replace("place:","http://maps.google.com/maps/place?cid="),
b="View on Google Place";if(!/^http/.test(c.website))c.website="http://"+c.website}else c.website=c.url,b="View on Google Place";a.html("<ul><li>"+c.formatted_address+"</li><li>"+c.formatted_phone_number+"</li><li>"+c.types.join(", ").replace(/_/g," ").toUpperCase()+"</li><li>"+(null!=c.rating?w(c.rating):"(No Rating Yet)")+'</li><li><a href="'+c.website+'" target="_blank">'+b+"</a></li></ul>");h=null!=(j=(i=app.user).place_search_history)?j:i.place_search_history=[];if(0===h.length||h[0].id!==app.selected_place.id)h.some(function(a,
b){return a.id===app.selected_place.id?(h.splice(b,1),!0):!1}),h.unshift({id:c.id,reference:app.selected_place.reference,name:c.name,vicinity:c.vicinity,icon:null!=(k=c.icon)?k.replace(/^http:/,""):void 0}),app.place_search_history_refresh();console.log(c);return this},app.selected_place.__detail?b(app.selected_place.__detail):app.offline()?alert("todo: offline mode"):e.plcsvc.getDetails({reference:app.selected_place.reference},function(a,d){if(d===google.maps.places.PlacesServiceStatus.OK)return app.selected_place.__detail=
a,b(a)}),this;app.back()}});$("#direction").bind({pagebeforeshow:function(){var a;if(app.offline())return app.back();a=$("#direction_panel");a.height(document.body.clientHeight-a.offset().top);return e.getCurPos(function(b,c){return e.dirsvc.route({origin:c,destination:app.selected_place.vicinity,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:!0},function(b,c){return c===google.maps.DirectionsStatus.OK?(e.dirrdr.setMap(e),
e.dirrdr.setPanel(a[0]),e.dirrdr.setDirections(b)):alert("Directions failed: "+c)})})},pagehide:function(){return e.dirrdr.setMap(null)}});console.log("Wilson",7)}).call(this);
