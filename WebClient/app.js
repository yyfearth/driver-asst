(function(){function C(a,c,b){function d(a,c){if(!a)return null;var b="",e=null;if(a.childNodes&&0<a.childNodes.length)for(var g=0;g<a.childNodes.length;g++){var i=a.childNodes[g],k=i.nodeType,f=i.localName||i.nodeName||"",l=i.text||i.nodeValue||"";if(8!=k)if(3==k||4==k||!f)b+=l.replace(/^\s+|\s+$/g,"");else if(e=e||{},e[f]){if(!(e[f]instanceof Array)||!e[f].length)e[f]=[e[f]];e[f].push(d(i,!0))}else e[f]=d(i,!1)}if(a.attributes&&!j&&0<a.attributes.length){e=e||{};for(i=0;i<a.attributes.length;i++)f=
a.attributes[i],k=f.name||"",f=f.value,e[k]?(!(e[k]instanceof Array)&&e[k].length&&(e[k]=[e[k]]),e[k].push(f)):e[k]=f}if(e){if(""!=b){i=new String(b);for(g in e)i[g]=e[g];e=i}if(b=e.text?("object"==typeof e.text?e.text:[e.text||""]).concat([b]):b)e.text=b;b=""}e=e||b;if(h){b&&(e={});if(b=e.text||b||"")e.text=b;!c&&!(e instanceof Array)&&(e=[e])}return e}var h=c,j=b;if(!a)return{};"string"==typeof a&&(a=D(a));if(a.nodeType){if(3==a.nodeType||4==a.nodeType)return a.nodeValue;a=9==a.nodeType?a.documentElement:
a;c=d(a,!0);a=a=null;return c}}function D(a){var c;try{var b=new DOMParser;b.async=!1;c=b.parseFromString(a,"text/xml")}catch(d){throw Error("Error parsing XML string");}return c}function t(a){for(var c=[],b=0;b<8*a.length;b+=8)c[b>>5]|=(a.charCodeAt(b/8)&255)<<24-b%32;a=8*a.length;c[a>>5]|=128<<24-a%32;c[(a+64>>9<<4)+15]=a;for(var a=Array(80),b=1732584193,d=-271733879,h=-1732584194,j=271733878,p=-1009589776,g=0;g<c.length;g+=16){for(var m=b,e=d,n=h,i=j,k=p,f=0;80>f;f++){a[f]=16>f?c[g+f]:(a[f-3]^
a[f-8]^a[f-14]^a[f-16])<<1|(a[f-3]^a[f-8]^a[f-14]^a[f-16])>>>31;var o=l(l(b<<5|b>>>27,20>f?d&h|~d&j:40>f?d^h^j:60>f?d&h|d&j|h&j:d^h^j),l(l(p,a[f]),20>f?1518500249:40>f?1859775393:60>f?-1894007588:-899497514)),p=j,j=h,h=d<<30|d>>>2,d=b,b=o}b=l(b,m);d=l(d,e);h=l(h,n);j=l(j,i);p=l(p,k)}c=[b,d,h,j,p];a="";for(b=0;b<4*c.length;b++)a+="0123456789abcdef".charAt(c[b>>2]>>8*(3-b%4)+4&15)+"0123456789abcdef".charAt(c[b>>2]>>8*(3-b%4)&15);return a}function l(a,c){var b=(a&65535)+(c&65535);return(a>>16)+(c>>16)+
(b>>16)<<16|b&65535}var m,o,u,v,r,g,w,s,x,y,q,z,A,B,n=function(a,c){return function(){return a.apply(c,arguments)}};window.app={back:function(){return history.go(-1)}};q=function(a){$.mobile.showPageLoadingMsg();$.ajax({url:"svc/"+a.svc+".svc/"+a.method,type:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(a.data),processdata:!1,complete:function(){$.mobile.hidePageLoadingMsg();return"function"===typeof a.complete?a.complete():void 0},success:function(c,b){if(null!=
(null!=c?c.d:void 0))return a.callback(c.d);alert("Network Error");return console.log("err",b,b.statusText)},error:function(a){alert("Network Error");return console.log("err",a,a.statusText)}});return!1};try{app.user=JSON.parse(sessionStorage.user||localStorage.user),0<(null!=(z=app.user)?z.uid:void 0)&&32===(null!=(A=app.user)?null!=(B=A.sid)?B.length:void 0:void 0)?(location.hash="#home",q({svc:"user",method:"check",data:{uid:app.user.uid,sid:app.user.sid},callback:function(a){console.log("check",
a);a||$.mobile.changePage("#login",{transition:"none"});return null}})):location.hash="#login"}catch(F){app.user=null}$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();m=document.body;w=$(document.querySelectorAll('[data-role="map"]'));$(window).resize(function(){console.log("resize",m.clientWidth,m.clientHeight);app.horizontal=m.clientWidth>m.clientHeight;return $(m)[app.horizontal?"addClass":
"removeClass"]("horizontal")});$(document.body).resize();$("#home").one({pageshow:function(){return g.el.offset($("#home_map").offset())}});g=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}});s=new google.maps.places.PlacesService(g);v=new google.maps.Geocoder;u=new google.maps.DirectionsService;o=new google.maps.DirectionsRenderer;y=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,
-122.728271),new google.maps.LatLng(37.247821,-121.552734));(function(){this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{setMarkers:n(function(a){console.log("markers",a);a?$.isArray(a)||(a=[a]):a=null;null!=this.markers&&this.markers.forEach(function(a){return a.setMap(null)});this.markers=null!=a?a.map(function(a){a.map=g;return new google.maps.Marker(a)}):null;return this},this),getCurPos:n(function(a,c){null==c&&(c=a,a=!0);null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(n(function(b){var d;
d=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);console.log("curlatlng",d);if(!d.equals(this.getCenter()))d.changed=!0;return a&&d.changed?(this.setMarkers(null),this.setCenter(d),w.each(n(function(a,b){return $(b).css("background-image","url('https://maps.googleapis.com/maps/api/staticmap?center="+d.lat()+","+d.lng()+"&zoom="+($(b).attr("data-map-zoom")||15)+"&size="+$(window).width()+"x"+this.el.height()+"&maptype=roadmap&format=png8&sensor=true&language=en')")},this)),v.geocode({latLng:d},
n(function(a,b){var g;b===google.maps.GeocoderStatus.OK?c.call(this,d,null!=(g=a[0])?g.formatted_address:void 0):alert("Geocoder failed due to: "+b+"\n App terminated!");return this.setCenter(d)},this))):c.call(this,d)},this),function(){return alert("App cannot run without geo location!")});return this},this)})}).call(g);$('[data-role="page"]').bind({pagebeforeshow:function(){return g.el.css({opacity:0,"z-index":0})},pageshow:function(){var a,c;$.mobile.fixedToolbars.show();this.hh=(null!=(a=$('[data-role="header"]',
this))?a.outerHeight():void 0)||0;this.fh=(null!=(c=$('[data-role="footer"]',this))?c.outerHeight():void 0)||0;this.bh=document.body.clientHeight-this.hh-this.fh;$(".map",this).add(g.el).height(this.bh*(app.horizontal?1:0.45));if($(this).hasClass("has-map"))return g.el.css({opacity:1,"z-index":1E4})}});console.log("user",app.user);$.ajax({url:"gapi?&hl=en-us&weather=san+jose,ca",dataType:"xml",success:function(a){var c,b,a=C(a);if(null!=(null!=(c=a.weather)?c.current_conditions:void 0))return c=a.weather.current_conditions,
console.log("w:",a),b=function(a){return"https://www.google.com"+a.icon.data},$("#weather").html('<div id="weather_now" class="weather"><img src="'+b(c)+'"/>'+c.condition.data+"<br/>"+c.temp_f.data+"\u00b0F</div>").append(a.weather.forecast_conditions.map(function(a){return'<div class="weather"><img src="'+b(a)+'"/>'+a.day_of_week.data+" "+a.high.data+"/"+a.low.data+"\u00b0F</div>"}).join("")),this},error:function(a){return console.log("get weather failed",a)}});try{console.log(localStorage.custom_search_history);
if(null!=localStorage.custom_search_history)app.history=JSON.parse(localStorage.custom_search_history);if(!$.isArray(app.history))app.history=[]}catch(E){console.log(E),app.history=[]}finally{app.history.refresh=n(function(){$("#history_list li:gt(0)").remove();return app.history.length?$("#history_list_header").after(app.history.map(function(a){return'<li><a href="#result" data-btn-role="search">'+a+"</a></li>"}).join("")):$("#history_list_header").after('<li data-role="list-divider" class="ui-body-c list-none">(None)</li>')},
this)}r=function(a,c){return t("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+t("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+"\u00ff"+c+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")+c+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")};
$("#home").bind({pagebeforeshow:function(){var a,c;if(32!==(null!=(a=app.user)?null!=(c=a.sid)?c.length:void 0:void 0))$.mobile.changePage("#login",{transition:"none"});else if(!$("#map",this).length)return console.log("home pageshow"),g.getCurPos(function(a,c){null!=c&&$("#home_addr").text(c);this.setZoom(15);return this.setMarkers({position:a})}),this}});$("#login").bind({pagecreate:function(){$("#login_form").submit(function(a){var c,b,d,g,j;a.preventDefault();a.stopPropagation();g=$("input",this).textinput("disable");
j=$("select",this).slider("disable");b=$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");d=$("#email").val().trim();a=$("#password").val();if(!d||!a)return!1;a=r(d.toLowerCase(),a);c="on"===$("#autologin").val();q({svc:"user",method:"login",data:{email:d,password:a},callback:function(a){var b;console.log(a);if(a.uid&&32===(null!=(b=a.sid)?b.length:void 0)){app.user={uid:a.uid,email:d,sid:a.sid};a=sessionStorage.user=JSON.stringify(app.user);if(c)localStorage.user=a;return $.mobile.changePage("#home",
{transition:"flip"})}return alert("Login Failed, please try again")},complete:function(){b.button("enable");g.textinput("enable");j.slider("enable");return $("#btn_reg").removeClass("ui-disabled")}});return!1});return this},pagebeforehide:function(){return $("#login_form_warp").hide()},pagebeforeshow:function(){return $("#login_form_warp").hide()},pageshow:function(){$("#login_form_warp").show();app.user=null;sessionStorage.user=null;return localStorage.user=null}});$("#reg_form").submit(function(a){var c,
b;a.preventDefault();a.stopPropagation();if(this.password.value!==this.password2.value)return alert("Password does not match!"),this.password2.focus(),!1;a=this.email.value.trim();c=this.password.value;c=r(a.toLowerCase(),c);b={email:a,password:c,fullname:{first:this.first.value.trim(),last:this.last.value.trim()},phone:this.phone.value.trim()};console.log("reg",b);q({svc:"user",method:"reg",data:{user:b},callback:function(a){console.log("new id:",a);if(1>a)return alert("Email already exists!");$("#email").val(b.email);
$("#reg").dialog("close");return alert("Registration successful!")}});return!1});$("#appointment").bind({pagebeforeshow:function(){var a,c;$("#datetime").val(Date(Date.parse(new Date)+36E5).toLocaleString());32!==(null!=(a=app.user)?null!=(c=a.sid)?c.length:void 0:void 0)&&$.mobile.changePage("#login",{transition:"flip",reverse:!0});return!1}});$("#appt_form").submit(function(a){var c,b,d;if(32!==(null!=(c=app.user)?null!=(b=c.sid)?b.length:void 0:void 0)||0===(null!=(d=app.user)?d.uid:void 0))return!1;
a.preventDefault();a.stopPropagation();a={user:app.user.uid,place:app.selected_place.id,contact:{name:this.name.value,phone:this.phone.value},datetime:"/Date("+Date.parse(this.datetime.value)+"-0000))/",message:this.comments.value};console.log("appt",a);q({svc:"appointment",method:"add",data:{appt:a,sid:app.user.sid},callback:function(a){console.log("appt success:",a);return a?($("#appointment").dialog("close"),alert("Appointment sent successful!")):$.mobile.changePage("#login",{transition:"flip",
reverse:!0})}});return!1});$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=$(this).text();console.log("vclick",app.search_keyword);return this}});$("#search_history").bind({pagecreate:function(){this.created=!0;app.history.refresh();return new google.maps.places.Autocomplete($("#input_search")[0],{bounds:y,types:["establishment"]})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#history_list").listview("refresh")});$("#custom_search_form").submit(function(){var a,
c;a=$("#input_search");c=$.trim(a.val());c.custom=!0;c?(app.search_keyword=c,$.mobile.changePage("#result"),console.log("vclick",app.history.search_keyword)):a.focus().val("");return!1});window.onbeforeunload=function(){localStorage.custom_search_history=JSON.stringify(app.history)};$("#result").bind({pagebeforeshow:function(){var a;console.log("search for",app.search_keyword);if(app.search_keyword)return $.mobile.showPageLoadingMsg(),a=$("#result_list").empty(),g.getCurPos(function(c){this.setZoom(12);
return s.search({location:c,radius:5E3,keyword:app.search_keyword},function(b,d){var h;d===google.maps.places.PlacesServiceStatus.ZERO_RESULTS?(alert("Zero Result"),app.back()):d===google.maps.places.PlacesServiceStatus.OK?($("#result_addr").text(""+app.search_keyword+" ("+b.length+")"),a.height(document.body.clientHeight-a.offset().top),console.log("search result",b),app.result_map={},b.forEach(function(a){var b,d;app.result_map[a.id]=a;a=a.geometry;d=a.location.lng()-c.lng();b=a.location.lat()-
c.lat();return a.dist=Math.pow(d,2)+Math.pow(b,2)}),b.sort(function(a,b){return a.geometry.dist-b.geometry.dist}),b=b.slice(0,25),a.append(b.map(function(a,b){var c;a.seq=String.fromCharCode(65+b);return'<li><a href="#detail" data-btn-role="result" id="'+a.id+'"><div style="float:left">'+a.seq+'</div><img src="'+(null!=(c=a.icon)?c.replace(/^http:/,"https:"):void 0)+'" class="ui-li-icon"><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("")),h=b.reverse().map(function(a){return{position:a.geometry.location,
icon:"https://www.google.com/mapfiles/marker"+a.seq+".png",title:a.name}}),a.listview("refresh"),h.push({position:c,icon:"https://www.google.com/mapfiles/arrow.png",title:"You are here"}),g.setMarkers(h),app.search_keyword.custom&&app.history[0]!==app.search_keyword&&(app.history.unshift(app.search_keyword),app.history.refresh())):alert("Search Error");return this})}),this;app.back()}});x=function(a){var c,b,a=Number(a);b=a.toFixed(1);c=a|0;0<c&&(b+=" "+Array(c+1).join('<img src="res/star.png"/>'));
0.4<a-c&&(b+='<img src="res/halfstar.png"/>');return b};$("#result_list a").live({vclick:function(){console.log(this.id);return app.selected_place=app.result_map[this.id]}});$("#detail").bind({pagecreate:function(){return $("#apt_cancel").bind({vclick:function(a){a.preventDefault();a.stopPropagation();$("#appointment").dialog("close");return!1}})},pageshow:function(){var a,c;a=$("#detial_info");a.height(document.body.clientHeight-a.offset().top-this.fh);console.log("detailof",app.selected_place);
window.scrollTop=0;if(app.selected_place)return c=function(b){g.setCenter(b.geometry.location);g.setMarkers({position:b.geometry.location});g.setZoom(15);$("#detail_place").text(b.name);a.html("<ul><li>"+b.formatted_address+"</li><li>"+b.formatted_phone_number+"</li><li>"+b.types.join(", ").replace(/_/g," ").toUpperCase()+"</li><li>"+(null!=b.rating?x(b.rating):"(No Rating Data)")+'</li><li><a href="'+(b.website||b.url)+'" target="_blank">'+(null!=b.website?"Visit its Website":"View on Google Place")+
"</a></li></ul>");return console.log(b)},app.selected_place.__detail?c(app.selected_place.__detail):s.getDetails({reference:app.selected_place.reference},function(a,d){if(d===google.maps.places.PlacesServiceStatus.OK)return app.selected_place.__detail=a,c(a)}),this;app.back()}});$("#direction").bind({pageshow:function(){var a;a=$("#direction_panel");a.height(document.body.clientHeight-a.offset().top);return g.getCurPos(function(c,b){return u.route({origin:b,destination:app.selected_place.vicinity,
travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:!0},function(b,c){return c===google.maps.DirectionsStatus.OK?(o.setMap(g),o.setPanel(a[0]),o.setDirections(b)):alert("Directions failed: "+c)})})},pagehide:function(){return o.setMap(null)}});console.log(2)}).call(this);
