(function(){function x(b,d,c){function e(b,d){if(!b)return null;var c="",f=null;if(b.childNodes&&0<b.childNodes.length)for(var g=0;g<b.childNodes.length;g++){var j=b.childNodes[g],n=j.nodeType,k=j.localName||j.nodeName||"",i=j.text||j.nodeValue||"";if(8!=n)if(3==n||4==n||!k)c+=i.replace(/^\s+|\s+$/g,"");else if(f=f||{},f[k]){if(!(f[k]instanceof Array)||!f[k].length)f[k]=[f[k]];f[k].push(e(j,!0))}else f[k]=e(j,!1)}if(b.attributes&&!l&&0<b.attributes.length){f=f||{};for(j=0;j<b.attributes.length;j++)k=
b.attributes[j],n=k.name||"",k=k.value,f[n]?(!(f[n]instanceof Array)&&f[n].length&&(f[n]=[f[n]]),f[n].push(k)):f[n]=k}if(f){if(""!=c){j=new String(c);for(g in f)j[g]=f[g];f=j}if(c=f.text?("object"==typeof f.text?f.text:[f.text||""]).concat([c]):c)f.text=c;c=""}f=f||c;if(h){c&&(f={});if(c=f.text||c||"")f.text=c;!d&&!(f instanceof Array)&&(f=[f])}return f}var h=d,l=c;if(!b)return{};"string"==typeof b&&(b=y(b));if(b.nodeType){if(3==b.nodeType||4==b.nodeType)return b.nodeValue;b=9==b.nodeType?b.documentElement:
b;d=e(b,!0);b=b=null;return d}}function y(b){var d;try{var c=new DOMParser;c.async=!1;d=c.parseFromString(b,"text/xml")}catch(e){throw Error("Error parsing XML string");}return d}function z(b){function d(b,c){var d=(b&65535)+(c&65535);return(b>>16)+(c>>16)+(d>>16)<<16|d&65535}var c;c=[];for(var e=0;e<8*b.length;e+=8)c[e>>5]|=(b.charCodeAt(e/8)&255)<<24-e%32;b=8*b.length;c[b>>5]|=128<<24-b%32;c[(b+64>>9<<4)+15]=b;for(var b=Array(80),e=1732584193,h=-271733879,l=-1732584194,o=271733878,g=-1009589776,
m=0;m<c.length;m+=16){for(var f=e,p=h,j=l,n=o,k=g,i=0;80>i;i++){b[i]=16>i?c[m+i]:(b[i-3]^b[i-8]^b[i-14]^b[i-16])<<1|(b[i-3]^b[i-8]^b[i-14]^b[i-16])>>>31;var q=d(d(e<<5|e>>>27,20>i?h&l|~h&o:40>i?h^l^o:60>i?h&l|h&o|l&o:h^l^o),d(d(g,b[i]),20>i?1518500249:40>i?1859775393:60>i?-1894007588:-899497514)),g=o,o=l,l=h<<30|h>>>2,h=e,e=q}e=d(e,f);h=d(h,p);l=d(l,j);o=d(o,n);g=d(g,k)}c=[e,h,l,o,g];b="";for(e=32;--e;){for(h=a=0;h<c.length;h++)a+=(c[h]&1)<<h,c[h]>>=1;b+="hzv4ut7rpmed91yw5ik6n8sobax32gfcy2y0f3e1a8r9t6h"[a]}return b}
var q,t,u,g,s,v,m,w,r,p=function(b,d){return function(){return b.apply(d,arguments)}};window.app={back:function(){return history.go(-1)}};location.hash=32===("undefined"!==typeof m&&null!==m?m.length:void 0)?"#home":"#login";$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();s=$(document.querySelectorAll('[data-role="map"]'));s.add("#map").height(Math.round(0.35*document.body.clientHeight));
$("#home").one({pageshow:function(){return g.el.offset($("#home_map").offset())}});g=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}});r=new google.maps.places.PlacesService(g);u=new google.maps.Geocoder;t=new google.maps.DirectionsService;q=new google.maps.DirectionsRenderer;w=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,-122.728271),new google.maps.LatLng(37.247821,
-121.552734));(function(){this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{move:p(function(){return this},this),setMarkers:p(function(b){console.log("markers",b);b?$.isArray(b)||(b=[b]):b=null;null!=this.markers&&this.markers.forEach(function(b){return b.setMap(null)});this.markers=null!=b?b.map(function(b){b.map=g;return new google.maps.Marker(b)}):null;return this},this),getCurPos:p(function(b,d){null==d&&(d=b,b=!0);null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(p(function(c){var e;
e=new google.maps.LatLng(c.coords.latitude,c.coords.longitude);console.log("curlatlng",e);if(!e.equals(this.getCenter()))e.changed=!0;return b?(this.setMarkers(null),this.setCenter(e),s.each(p(function(b,c){return $(c).css("background-image","url('https://maps.googleapis.com/maps/api/staticmap?center="+e.lat()+","+e.lng()+"&zoom="+($(c).attr("data-map-zoom")||15)+"&size="+$(window).width()+"x"+this.el.height()+"&maptype=roadmap&format=png8&sensor=true')")},this)),u.geocode({latLng:e},p(function(b,
c){var g;c===google.maps.GeocoderStatus.OK?d.call(this,e,null!=(g=b[0])?g.formatted_address:void 0):alert("Geocoder failed due to: "+c+"\n App terminated!");return this.setCenter(e)},this))):d.call(this,e)},this),function(){return alert("App cannot run without geo location!")});return this},this)})}).call(g);$('[data-role="page"]').bind({pagebeforeshow:function(){return g.el.css("opacity",0).show()},pageshow:function(){return g.el[$(this).hasClass("has-map")?"show":"hide"]().css("opacity",1)}});$("#home").bind({pageshow:function(){},
pagebeforeshow:function(){if(!("undefined"!==typeof m&&null!==m)||32!==m.length)$.mobile.changePage("#login",{transition:"none"});else if(!$("#map",this).length)return console.log("home pageshow"),g.getCurPos(function(b,d){$("#home_addr").text(d);this.setZoom(15);this.setMarkers({position:b});return this.move("home")}),this},pagehide:function(){}});m=sessionStorage.sid||localStorage.sid;r=function(b){$.mobile.showPageLoadingMsg();$.ajax({url:"svc/"+b.svc+".svc/"+b.method,type:"POST",dataType:"json",
contentType:"application/json;charset=utf-8",data:JSON.stringify(b.data),processdata:!1,complete:function(){$.mobile.hidePageLoadingMsg();return"function"===typeof b.complete?b.complete():void 0},success:function(d,c){if(null!=(null!=d?d.d:void 0))return b.callback(d.d);alert("Network Error");return console.log("err",c,c.statusText)},error:function(b){alert("Network Error");return console.log("err",b,b.statusText)}});return!1};$("#login").bind({pagecreate:function(){return $("#login_form").bind({submit:function(b){var d,
c,e,g,l;b.preventDefault();b.stopPropagation();g=$("input",this).textinput("disable");l=$("select",this).slider("disable");c=$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");e=$("#email").val().trim();b=$("#password").val();if(!e||!b)return!1;b=z("\x00"+e+"\u00ffKnightRider\u00ff"+b+"\x00X\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ff");d="on"===$("#autologin").val();r({svc:"user",method:"login",data:{email:e,password:b},callback:function(b){var f;
var c;console.log(b);if(b.uid&&32===(null!=(c=b.sid)?c.length:void 0)){m=sessionStorage.sid=b.sid;if(d)localStorage.sid=m;f=sessionStorage.user={uid:b.uid,email:e},b=f;if(d)localStorage.user=b;return $.mobile.changePage("#home",{transition:"flip"})}return alert("Login Failed, please try again")},complete:function(){c.button("enable");g.textinput("enable");l.slider("enable");return $("#btn_reg").removeClass("ui-disabled")}});return this}})},pagebeforehide:function(){return $("#login_form_warp").hide()},
pagebeforeshow:function(){return $("#login_form_warp").hide()},pageshow:function(){$("#login_form_warp").show();return localStorage.sid=sessionStorage.sid=m=null}});$.ajax({url:"gapi?&hl=en-us&weather=san+jose,ca",dataType:"xml",success:function(b){var d,c;c=x(b);b=c.weather.current_conditions;console.log("w:",c);d=function(b){return"https://www.google.com"+b.icon.data};$("#weather").html('<div id="weather_now" class="weather"><img src="'+d(b)+'"/>'+b.condition.data+"<br/>"+b.temp_f.data+"\u00b0F</div>").append(c.weather.forecast_conditions.map(function(b){return'<div class="weather"><img src="'+
d(b)+'"/>'+b.day_of_week.data+" "+b.high.data+"/"+b.low.data+"\u00b0F</div>"}).join(""));return this},error:function(b){return console.log("get weather failed",b)}});try{console.log(localStorage.custom_search_history);if(null!=localStorage.custom_search_history)app.history=JSON.parse(localStorage.custom_search_history);if(!$.isArray(app.history))app.history=[]}catch(A){console.log(A),app.history=[]}finally{app.history.refresh=p(function(){$("#history_list li:gt(0)").remove();return app.history.length?
$("#history_list_header").after(app.history.map(function(b){return'<li><a href="#result" data-btn-role="search">'+b+"</a></li>"}).join("")):$("#history_list_header").after('<li data-role="list-divider" class="ui-body-c list-none">(None)</li>')},this)}$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=$(this).text();console.log("vclick",app.search_keyword);return this}});$("#search_history").bind({pagecreate:function(){this.created=!0;app.history.refresh();return new google.maps.places.Autocomplete($("#input_search")[0],
{bounds:w,types:["establishment"]})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#history_list").listview("refresh")});$("#custom_search_form").submit(function(){var b,d;b=$("#input_search");(d=$.trim(b.val()))?(app.search_keyword=d,$.mobile.changePage("#result"),console.log("vclick",app.history.search_keyword)):b.focus().val("");return!1});window.onbeforeunload=function(){localStorage.custom_search_history=JSON.stringify(app.history)};$("#result").bind({pageshow:function(){var b;
console.log("search for",app.search_keyword);if(app.search_keyword)return b=$("#result_list").empty(),g.getCurPos(function(d){this.setZoom(12);this.move("result");return r.search({location:d,radius:5E3,keyword:app.search_keyword},function(c,e){var h;e===google.maps.places.PlacesServiceStatus.ZERO_RESULTS?(alert("Zero Result"),app.back()):e===google.maps.places.PlacesServiceStatus.OK?($("#result_addr").text(""+app.search_keyword+" ("+c.length+")"),b.height(document.body.clientHeight-b.offset().top),
console.log("search result",c),app.result_map={},c.forEach(function(b){var c,e;app.result_map[b.id]=b;b=b.geometry;e=b.location.lng()-d.lng();c=b.location.lat()-d.lat();return b.dist=Math.pow(e,2)+Math.pow(c,2)}),c.sort(function(b,c){return b.geometry.dist-c.geometry.dist}),c=c.slice(0,25),b.append(c.map(function(b,c){var d;b.seq=String.fromCharCode(65+c);return'<li><a href="#detail" data-btn-role="result" id="'+b.id+'"><div style="float:left">'+b.seq+'</div><img src="'+(null!=(d=b.icon)?d.replace(/^http:/,
"https:"):void 0)+'" class="ui-li-icon"><h3 class="ui-li-heading">'+b.name+'</h3><p class="ui-li-desc">'+b.vicinity+"</p></li>"}).join("")),h=c.reverse().map(function(b){return{position:b.geometry.location,icon:"https://www.google.com/mapfiles/marker"+b.seq+".png",title:b.name}}),b.listview("refresh"),h.push({position:d,icon:"https://www.google.com/mapfiles/arrow.png",title:"You are here"}),g.setMarkers(h),app.history[0]!==app.search_keyword&&(app.history.unshift(app.search_keyword),app.history.refresh())):
alert("Search Error");return this})}),this;app.back()}});v=function(b){var d,c,b=Number(b);c=b.toFixed(1);d=b|0;0<d&&(c+=" "+Array(d+1).join('<img src="res/star.png"/>'));0.4<b-d&&(c+='<img src="res/halfstar.png"/>');return c};$("#result_list a").live({vclick:function(){console.log(this.id);return app.selected_place=app.result_map[this.id]}});$("#detail").bind({pageshow:function(){console.log("detailof",app.selected_place);if(app.selected_place)return $("#apt_cancel").bind({vclick:function(){return $("#appointment").dialog("close")}}),
r.getDetails({reference:app.selected_place.reference},function(b,d){if(d===google.maps.places.PlacesServiceStatus.OK)return g.setCenter(b.geometry.location),g.setMarkers({position:b.geometry.location}),g.setZoom(15),$("#detail_place").text(b.name),$("#detial_info").html("<ul><li>"+b.formatted_address+"</li><li>"+b.formatted_phone_number+"</li><li>"+b.types.join(", ").replace(/_/g," ").toUpperCase()+"</li><li>"+(null!=b.rating?v(b.rating):"(No Rating Data)")+'</li><li><a href="'+(b.website||b.url)+
'" target="_blank">'+(null!=b.website?"Visit its Website":"View on Google Place")+"</a></li></ul>"),console.log(b)});app.back()}});$("#direction").bind({pageshow:function(){return g.getCurPos(function(b,d){return t.route({origin:d,destination:app.selected_place.vicinity,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:!0},function(b,d){return d===google.maps.DirectionsStatus.OK?(q.setMap(g),q.setPanel($("#direction_panel")[0]),
q.setDirections(b)):alert("Directions failed: "+d)})})},pagehide:function(){return q.setMap(null)}});console.log(2)}).call(this);
