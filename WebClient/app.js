(function(){function E(a,b,c){function d(a,b){if(!a)return null;var c="",g=null;if(a.childNodes&&0<a.childNodes.length)for(var f=0;f<a.childNodes.length;f++){var l=a.childNodes[f],n=l.nodeType,i=l.localName||l.nodeName||"",j=l.text||l.nodeValue||"";if(8!=n)if(3==n||4==n||!i)c+=j.replace(/^\s+|\s+$/g,"");else if(g=g||{},g[i]){if(!(g[i]instanceof Array)||!g[i].length)g[i]=[g[i]];g[i].push(d(l,!0))}else g[i]=d(l,!1)}if(a.attributes&&!h&&0<a.attributes.length){g=g||{};for(l=0;l<a.attributes.length;l++)i=
a.attributes[l],n=i.name||"",i=i.value,g[n]?(!(g[n]instanceof Array)&&g[n].length&&(g[n]=[g[n]]),g[n].push(i)):g[n]=i}if(g){if(""!=c){l=new String(c);for(f in g)l[f]=g[f];g=l}if(c=g.text?("object"==typeof g.text?g.text:[g.text||""]).concat([c]):c)g.text=c;c=""}g=g||c;if(e){c&&(g={});if(c=g.text||c||"")g.text=c;!b&&!(g instanceof Array)&&(g=[g])}return g}var e=b,h=c;if(!a)return{};"string"==typeof a&&(a=G(a));if(a.nodeType){if(3==a.nodeType||4==a.nodeType)return a.nodeValue;a=9==a.nodeType?a.documentElement:
a;b=d(a,!0);a=a=null;return b}}function G(a){var b;try{var c=new DOMParser;c.async=!1;b=c.parseFromString(a,"text/xml")}catch(d){throw Error("Error parsing XML string");}return b}function x(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;a=8*a.length;b[a>>5]|=128<<24-a%32;b[(a+64>>9<<4)+15]=a;for(var a=Array(80),c=1732584193,d=-271733879,e=-1732584194,h=271733878,f=-1009589776,q=0;q<b.length;q+=16){for(var F=c,g=d,k=e,l=h,n=f,i=0;80>i;i++){a[i]=16>i?b[q+i]:(a[i-3]^
a[i-8]^a[i-14]^a[i-16])<<1|(a[i-3]^a[i-8]^a[i-14]^a[i-16])>>>31;var m=j(j(c<<5|c>>>27,20>i?d&e|~d&h:40>i?d^e^h:60>i?d&e|d&h|e&h:d^e^h),j(j(f,a[i]),20>i?1518500249:40>i?1859775393:60>i?-1894007588:-899497514)),f=h,h=e,e=d<<30|d>>>2,d=c,c=m}c=j(c,F);d=j(d,g);e=j(e,k);h=j(h,l);f=j(f,n)}b=[c,d,e,h,f];a="";for(c=0;c<4*b.length;c++)a+="0123456789abcdef".charAt(b[c>>2]>>8*(3-c%4)+4&15)+"0123456789abcdef".charAt(b[c>>2]>>8*(3-c%4)&15);return a}function j(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+
(c>>16)<<16|c&65535}var r,k,s,u,v,w,f,y,t,z,m,A,o,B,C,D,p=function(a,b){return function(){return a.apply(b,arguments)}};window.offline_mode=!navigator.onLine;window.app={back:function(){return history.go(-1)},autologin:"on"===$("#autologin").val(),offline:function(){return window.offline_mode||!navigator.onLine}};(function(){return window.offline_mode&&navigator.onLine?confirm("You are online now, \npress OK to reload the App and enable online features!")?location.reload():setTimeout(arguments.callee,
6E4):setTimeout(arguments.callee,1E4)})();app.offline()&&$(document.body).addClass("offline");applicationCache.onupdateready=function(){applicationCache.swapCache();if(confirm("Application has been updated just now.\nIn order to work properly, \nPLEASE CLICK OK to reload this Application as soon as possible."))return location.reload};o={remove_regex:/on\w{1,20}?=|javascript:/ig,replace_regex:/<|>/g,replace_dict:{">":"&gt;","<":"&lt;"},attr:function(a){return a.replace(/[\n'"]/g,"\\$0")},str:function(a){return a=
a.toString().replace(this.remove_regex,"".replace(this.replace_regex,function(a){return this.replace_dict[a]}))},json:function(a,b){var c;(c="string"===typeof a)||(a=JSON.stringify(a));a=this.str(a);return c||!b?a:JSON.parse(a)}};m=function(a,b){if(null!=a.svc&&null==b)b=a,a=b.svc;else if("string"===typeof a)b.svc=a;b.type=null!=b.type&&/get/i.test(b.type)?"GET":"POST";if(b.nowait)b.background=!0;if("POST"===b.type)b.data=o.json(b.data);console.log(b.data);b.background||$.mobile.showPageLoadingMsg();
$.ajax({url:"svc/ajax/"+b.svc+".svc/"+b.method,type:b.type,dataType:"json",contentType:"application/json;charset=utf-8",data:b.data,processdata:"POST"!==b.type,dataFilter:function(a,b){console.log("data form ajax",b,a);return o.str(a)},complete:b.background?null:function(){console.log("ajax returned");$.mobile.hidePageLoadingMsg();return"function"===typeof b.complete?b.complete():void 0},success:b.nowait?null:function(a,d,e){console.log("ajax success",a);if(null!=a&&"d"in a)return"function"===typeof b.callback?
b.callback(a.d):void 0;alert("Network Error");return console.log("err",e,e.statusText)},error:function(a){alert("Network Error");return console.log("err",a,a.statusText)}});return!1};A=function(a){return $.ajax({url:"gapi?&hl=en-us&weather=san+jose,ca",dataType:"json",dataFilter:function(a){return o.json(JSON.stringify(E(a)))},success:function(b){return a(b)},error:function(a){return console.log("get weather failed",a)}})};k={fmt:function(a){return 9<a?a.toString():"0"+a},dateToWcf:function(a){var b;
b=(new Date).getTimezoneOffset()/60;return"/Date("+ +(Date.parse(a)-36E5*b)+(0<b?"-":"+")+(9<b?"":"0")+b+"00)/"},dateFromWcf:function(a){a=a.match(/^\/Date\((\d+)([+-]\d{2})(\d{2})\)\/$/);return 4!==a.length?null:new Date(Number(a[1]))},dateFromStr:function(a){return new Date(a.replace(/-/g,"/"))},dateToStr:function(a){a=new Date(a);return""+a.getFullYear()+"-"+this.fmt(a.getMonth()+1)+"-"+this.fmt(a.getDate())+" "+this.fmt(a.getHours())+":"+this.fmt(a.getMinutes())+":"+this.fmt(a.getSeconds())},
dateFromWcfToStr:function(a){return this.dateToStr(this.dateFromWcf(a))},dateToUTC:function(a){a=new Date(a);return""+a.getUTCFullYear()+"-"+this.fmt(a.getUTCMonth()+1)+"-"+this.fmt(a.getUTCDate())+"T"+this.fmt(a.getUTCHours())+":"+this.fmt(a.getUTCMinutes())+":"+this.fmt(a.getUTCSeconds())}};try{app.user=JSON.parse(sessionStorage.user||localStorage.user),0<(null!=(B=app.user)?B.uid:void 0)&&32===(null!=(C=app.user)?null!=(D=C.sid)?D.length:void 0:void 0)?(location.hash="#home",app.offline()||m("user",
{method:"check",data:{uid:app.user.uid,sid:app.user.sid},callback:function(a){console.log("check",a);a||$.mobile.changePage("#login",{transition:"none"});return null}})):location.hash="#login"}catch(H){app.user=null,location.hash="#login"}console.log("app.user",app.user);app.save_profile=window.onbeforeunload=function(){var a;if(null!=(a=app.user)&&a.uid){if(a=sessionStorage.user=JSON.stringify(app.user),app.autologin)localStorage.user=a}else localStorage.removeItem("user"),sessionStorage.removeItem("user")};
app.reset=function(){app.db.reset();app.user=null;app.save_profile();window.onbeforeunload=$.noop;return location.reload()};$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();r=document.body;y=$(document.querySelectorAll('[data-role="map"]'));$(window).resize(function(){app.horizontal=r.clientWidth>r.clientHeight;return $(r)[app.horizontal?"addClass":"removeClass"]("horizontal")});$(document.body).resize();
f=app.map=null;if(!app.offline())f=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}}),f.plcsvc=new google.maps.places.PlacesService(f),f.geocoder=new google.maps.Geocoder,f.dirsvc=new google.maps.DirectionsService,f.dirrdr=new google.maps.DirectionsRenderer,f.svbounds=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,-122.728271),new google.maps.LatLng(37.247821,
-121.552734)),function(){this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{setMarkers:p(function(a){a?$.isArray(a)||(a=[a]):a=null;null!=this.markers&&this.markers.forEach(function(a){return a.setMap(null)});this.markers=null!=a?a.map(function(a){a.map=f;return new google.maps.Marker(a)}):null;return this},this),getCurPos:p(function(a,b){null==b&&(b=a,a=!0);app.offline()?b.call(this,null,null):null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(p(function(c){var d;
d=f.lastlatlng=new google.maps.LatLng(c.coords.latitude,c.coords.longitude);if(!d.equals(this.getCenter()))d.changed=!0;return a&&d.changed?(this.setMarkers(null),this.setCenter(d),y.each(p(function(a,b){return $(b).css("background-image","url('//maps.googleapis.com/maps/api/staticmap?center="+d.lat()+","+d.lng()+"&zoom="+($(b).attr("data-map-zoom")||15)+"&size="+$(window).width()+"x"+this.el.height()+"&maptype=roadmap&format=png8&sensor=true&language=en')")},this)),f.geocoder.geocode({latLng:d},
p(function(a,c){var f;c===google.maps.GeocoderStatus.OK?b.call(this,d,null!=(f=a[0])?f.formatted_address:void 0):alert("Geocoder failed due to: "+c+"\n App terminated!");return this.setCenter(d)},this))):b.call(this,d)},this),function(){return alert("App cannot run without geo location!")});return this},this)})}.call(f),$('[data-role="page"]').bind({pagebeforeshow:function(){f.el.addClass("hidden");return $(document.body)[app.offline()?"addClass":"removeClass"]("offline")},pageshow:function(){var a,
b;$.mobile.fixedToolbars.show();this.hh=(null!=(a=$('[data-role="header"]',this))?a.outerHeight():void 0)||0;this.fh=(null!=(b=$('[data-role="footer"]',this))?b.outerHeight():void 0)||0;this.bh=document.body.clientHeight-this.hh-this.fh;f.el.css("top",this.hh);$(".map",this).add(f.el).height(this.bh*(app.horizontal?1:0.45));if($(this).hasClass("has-map"))return f.el.removeClass("hidden")}});app.sync_weather=function(){var a;a=function(a){var c,d;null!=(null!=(c=a.weather)?c.current_conditions:void 0)?
(c=a.weather.current_conditions,console.log("weather",a),d=function(a){return"//www.google.com"+a.icon.data},c=$("#weather").html('<div id="weather_now" class="weather"><img src="'+d(c)+'"/>'+c.condition.data+"<br/>"+c.temp_f.data+"\u00b0F</div>"),c.append(a.weather.forecast_conditions.map(function(a){return'<div class="weather"><img src="'+d(a)+'"/>'+a.day_of_week.data+" "+a.high.data+"/"+a.low.data+"\u00b0F</div>"}).join(""))):$("#weather").html("(No Weather Data)");return this};return app.offline()?
null!=localStorage.weather?a(JSON.parse(localStorage.weather)):a(null):A(function(b){localStorage.weather=JSON.stringify(b);return a(b)})};s=function(a,b){return x("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+x("KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider"+a+"\u00ff"+b+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")+
b+"KnightRiderX\u00b5\u0004\u0005\u00f1PGo\u00f0@\u00d8\u00f4\u00ed\u009d\u00d2y\u00c0n\u00a6\u00d9\u00ffKnightRider")};if(null!=window.openDatabase)app.db=openDatabase("KnightRider","1.0","Data cache for Knight Rider",2E5),null!=app.db?(app.db._onerr=function(a,b){return console.error("local db error",a,b)},app.db.reset=function(){return app.db.transaction(function(a){a.executeSql("DROP TABLE IF EXISTS Alerts;");return a.executeSql("DROP TABLE IF EXISTS Place;")})},app.db.sync=function(a,b){console.log("sync",
a);a=a.toLowerCase();app.db.transaction(function(c){return c.executeSql("SELECT modified FROM ["+a+"] WHERE id=0",[],function(c,e){var h;h=e.rows.item(0);console.log("last",a,h);return m(a,{method:"sync",type:"get",background:!0,data:{last:k.dateToStr(h.modified.replace(/-/g,"/"))},callback:function(c){console.log("sync",a,c);return"function"===typeof b?b(c):void 0}})})});return this},w=function(a,b){var c,d,e;e=[];for(c=a.length;c;)d=$.extend({},a.item(--c)),d.created=new Date(d.created.replace(/-/g,
"/")),d.modified=new Date(d.modified.replace(/-/g,"/")),"function"===typeof b&&b(d),e.unshift(d);return e},v=function(a){return w(a,function(a){a.canappt=/true/i.test(a.canappt);return a.location={lat:a.lat,lng:a.lng}})},u=function(a,b){a.executeSql("SELECT * FROM [Alerts] WHERE status=1 and expired > DATETIME('now','localtime')ORDER BY datetime DESC, importance DESC;",[],function(a,d){var e;e=w(d.rows,function(a){a.datetime=new Date(a.datetime.replace(/-/g,"/"));return a.expired=new Date(a.expired.replace(/-/g,
"/"))});console.log("alerts from db",e,d);return"function"===typeof b?b(e,"alerts"):void 0},app.db._onerr);return this},app.db.sync_alerts=function(a){app.offline()?app.db.transaction(function(b){return u(b,a)}):app.db.sync("alerts",function(b){app.db.transaction(function(c){var d,e;b.length&&(d=b.map(function(a){return a.id}),e=b.map(function(a){return[a.id,a.summary,a.message,k.dateFromWcfToStr(a.datetime),k.dateFromWcfToStr(a.expired),a.importance,a.type,a.status,k.dateFromWcfToStr(a.created),
k.dateFromWcfToStr(a.modified)]}),console.log("db","INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",e),c.executeSql("DELETE FROM [Alerts] WHERE id IN ("+d.join(",")+")"),e.forEach(function(a){return c.executeSql("INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",a)}),c.executeSql("UPDATE [Alerts] SET modified=DATETIME('now','localtime') WHERE id=0"));
u(c,a);return this});return this});return this},app.db.sync_place=function(){return app.offline()?void 0:app.db.sync("place",function(a){if(a.length)return app.db.transaction(function(b){var c,d;c=a.map(function(a){return a.id});d=a.map(function(a){return[a.id,a.gid,a.name,a.location.lat,a.location.lng,a.vicinity,a.fulladdr,a.phone,a.email,a.website,a.rating,a.gtypes,a.svctypes,a.openhours,a.canappt,a.status,k.dateFromWcfToStr(a.created),k.dateFromWcfToStr(a.modified)]});console.log("db","INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,email,website,rating,gtypes,svctypes,openhours,canappt,status,created,modified)VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",
d);b.executeSql("DELETE FROM [Place] WHERE id IN ("+c.join(",")+")");d.forEach(function(a){return b.executeSql("INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,email,website,rating,gtypes,svctypes,openhours,canappt,status,created,modified)VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",a,null,app.db._onerr)});return b.executeSql("UPDATE [Place] SET modified=DATETIME('now','localtime') WHERE id=0")})})},app.db.query_place=function(a,b){app.db.transaction(function(c){return c.executeSql("SELECT * FROM [Place] WHERE status<>0 and svctypes&"+
a+"<>0;",[],function(a,c){var h;h=v(c.rows);console.log("place from db",h,c);return"function"===typeof b?b(h):void 0},app.db._onerr)});return this},app.db.get_place=function(a,b){$.isArray(a)||(a=[a]);app.db.transaction(function(c){return c.executeSql("SELECT * FROM [Place] WHERE gid in ('"+a.join("','")+"');",[],function(a,c){var h;h=v(c.rows);return"function"===typeof b?b(h):void 0},app.db._onerr)});return this},app.db.transaction(function(a){console.log("init tables");a.executeSql("CREATE TABLE IF NOT EXISTS [Alerts] (\t\t\t\tid int not null primary key, \t\t\t\tsummary nvarchar(100) not null, \t\t\t\tmessage text, \t\t\t\tdatetime datetime, \t\t\t\texpired datetime, \t\t\t\timportance tinyint not null, \t\t\t\ttype tinyint not null, \t\t\t\tstatus tinyint not null,\t\t\t\tcreated datetime not null, \t\t\t\tmodified datetime not null\t\t\t);");
a.executeSql("CREATE INDEX IF NOT EXISTS [Alerts_ODR] ON [Alerts] (datetime DESC, importance DESC);");a.executeSql("INSERT INTO [Alerts](id,summary,importance,type,status,created,modified)SELECT 0,'LastUpdate',0,0,0,DATETIME('now','localtime'),DATETIME(0,'unixepoch','localtime')WHERE NOT EXISTS(SELECT * FROM [Alerts] WHERE id=0);");a.executeSql("CREATE TABLE IF NOT EXISTS [Place] (\t\t\t\tid int not null primary key, \t\t\t\tgid char(40),\t\t\t\tname nvarchar(100),\t\t\t\tlat float,\t\t\t\tlng float,\t\t\t\tvicinity nvarchar(200),\t\t\t\tfulladdr nvarchar(1000),\t\t\t\tphone varchar(15),\t\t\t\temail varchar(100),\t\t\t\twebsite varchar(100),\t\t\t\trating tinyint,\t\t\t\tgtypes varchar(100),\t\t\t\tsvctypes tinyint not null,\t\t\t\topenhours text,\t\t\t\tcanappt bit not null,\t\t\t\tstatus tinyint not null,\t\t\t\tcreated datetime not null,\t\t\t\tmodified datetime not null\t\t\t);");
a.executeSql("CREATE UNIQUE INDEX IF NOT EXISTS [Place_GID] ON [Place] (GID);");a.executeSql("CREATE INDEX IF NOT EXISTS [Place_TYP] ON [Place] (svctypes);");return a.executeSql("INSERT INTO [Place](id,name,canappt,svctypes,status,created,modified)SELECT 0,'LastUpdate',0,0,0,DATETIME('now','localtime'),DATETIME(0,'unixepoch','localtime')WHERE NOT EXISTS(SELECT * FROM [Place] WHERE id=0);")})):alert("open db err");$("#home").bind({pagecreate:function(){return this.created=!0},pagebeforeshow:function(){app.offline()?
$("#home_addr").text("You are offline now"):window.offline_mode||f.getCurPos(function(a,b){null!=b&&$("#home_addr").text(b);this.setZoom(15);return this.setMarkers({position:a})});app.sync_weather();app.db.sync_place();app.db.sync_alerts(function(a){var b;console.log("alerts",a);$("#alerts").empty();b='<li data-role="list-divider" class="ui-body-c list-none">No Alerts</li>';0<a.length&&(b='<li data-role="list-divider" class="ui-body-c list-none">'+a.length+" Alerts</li>"+a.map(function(a){return"<li><a href=\"javascript:alert('"+
o.attr("Summary: "+a.summary+"\\nMessage: "+a.message+"\\nFrom: "+a.datetime+"\\nExpire: "+a.expired)+"')\">"+a.summary+" ("+a.datetime.toLocaleDateString()+")</a></li>"}).join(""));return $("#alerts").html(b).listview().listview("refresh")});return this},pageshow:function(){var a;a=$("#alerts");return a.height(document.body.clientHeight-a.offset().top-this.fh)}});$("#login").bind({pagecreate:function(){$("#login_form").submit(function(a){var b,c,d,e,h;a.preventDefault();a.stopPropagation();if(app.offline())return!1;
d=$("input",this).textinput("disable");h=$("select",this).slider("disable");b=$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");c=$("#email").val().trim();a=$("#password").val();if(!c||!a)return!1;e=s(c.toLowerCase(),a);app.autologin="on"===$("#autologin").val();m("user",{method:"login",data:{email:c,password:e},callback:function(a){var b;return a.uid&&32===(null!=(b=a.sid)?b.length:void 0)?(app.user={uid:a.uid,email:c,sid:a.sid,psw:s(a.sid+a.uid+e)},$.mobile.changePage("#home",
{transition:"flip"})):alert("Login Failed, please try again")},complete:function(){b.button("enable");d.textinput("enable");h.slider("enable");return $("#btn_reg").removeClass("ui-disabled")}});return!1});return this},pagebeforehide:function(){return $("#login_form_warp").hide()},pagebeforeshow:function(){return $("#login_form_warp").hide()},pageshow:function(){$("#password").val("");$("#login_form_warp").show();if(app.offline())$("button",this).button("disable"),$("#btn_reg").addClass("ui-disabled"),
app.offline()&&alert("You are offline now!\nLogin need a network.");else{$("button",this).button("enable");$("#btn_reg").removeClass("ui-disabled");if(null==app.user)return;console.log("logout",app.user);m("user",{method:"logout",nowait:!0,data:{uid:app.user.uid,sid:app.user.sid}});app.user=null;app.save_profile()}return this}});$("#reg_form").submit(function(a){var b,c;a.preventDefault();a.stopPropagation();if(app.offline())return!1;if(this.password.value!==this.password2.value)return alert("Password does not match!"),
this.password2.focus(),!1;a=this.email.value.trim();b=this.password.value;b=s(a.toLowerCase(),b);c={email:a,password:b,fullname:{first:this.first.value.trim(),last:this.last.value.trim()},phone:this.phone.value.trim()};console.log("reg",c);m("user",{method:"reg",data:{user:c},callback:function(a){console.log("new id:",a);if(1>a)return alert("Email already exists!");$("#email").val(c.email);$("#reg").dialog("close");return alert("Registration successful!")}});return!1});$("#appointment").bind({pagebeforeshow:function(){var a,
b;if(app.offline())return app.back();$("#datetime").val(Date((new Date).getTime()+36E5).toLocaleString());32!==(null!=(a=app.user)?null!=(b=a.sid)?b.length:void 0:void 0)&&$.mobile.changePage("#login",{transition:"flip",reverse:!0});return!1}});$("#appt_form").submit(function(a){var b,c,d;if(32!==(null!=(b=app.user)?null!=(c=b.sid)?c.length:void 0:void 0)||0===(null!=(d=app.user)?d.uid:void 0)||app.offline())return!1;a.preventDefault();a.stopPropagation();a={user:app.user.uid,place:app.selected_place.gid,
contact:{name:this.name.value,phone:this.phone.value},datetime:k.dateToWcf(this.datetime.value),message:this.comments.value};console.log("appt",a);m("appointment",{method:"add",data:{appt:a,sid:app.user.sid},callback:function(a){console.log("appt success:",a);return a?($("#appointment").dialog("close"),alert("Appointment sent successful!")):$.mobile.changePage("#login",{transition:"flip",reverse:!0})}});return!1});$("#search").bind({pageshow:function(){return $("#btn_custom_search")[app.offline()?
"addClass":"removeClass"]("ui-disabled")}});$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=$(this).text();return this}});app.custom_search_history_refresh=function(){var a,b;$("#custom_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if(null!=(b=app.user.custom_search_history)&&b.length)a=app.user.custom_search_history.map(function(a){return'<li><a href="#result" data-btn-role="search">'+a+"</a></li>"}).join("");return $("#custom_history_list_header").after(a)};
app.place_search_history_refresh=function(){var a,b;$("#search_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if(null!=(b=app.user.place_search_history)&&b.length)a=app.user.place_search_history.map(function(a,b){var e;e=null!=a.icon&&!app.offline()?'<img src="'+a.icon+'" class="ui-li-icon"/>':"";return'<li><a href="#detail" data-btn-role="result" data-index="'+b+'">'+e+'<h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+
"</p></li>"}).join("");return $("#search_history_list_header").after(a)};$("#custom_search").bind({pagecreate:function(){this.created=!0;app.custom_search_history_refresh();if(!app.offline())return new google.maps.places.Autocomplete($("#input_search")[0],{bounds:f.svbounds,types:["establishment"]})},pagebeforeshow:function(){if(app.offline())return app.back()}});$("#custom_search").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#custom_history_list").listview("refresh")});$("#custom_search_form").submit(function(){var a,
b;a=$("#input_search");(b=$.trim(a.val()))?(app.search_keyword=new String(b),$.mobile.changePage("#result")):a.focus().val("");return!1});$("#search_history").bind({pagecreate:function(){this.created=!0;app.place_search_history_refresh();return $("#search_history li a").live({vclick:function(){return app.selected_place=app.user.place_search_history[Number($(this).attr("data-index"))]}})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#search_history_list").listview("refresh")});
t={"Service Station":2,"Gas Station":4,"Towing Station":8,"Vehicle Repair Station":16};$("#result").bind({pageshow:function(){var a;a=$("#result_list");a.height(document.body.clientHeight-a.offset().top);return this},pagebeforeshow:function(){var a,b,c;console.log("search for",app.search_keyword);if(app.search_keyword)return $.mobile.showPageLoadingMsg(),b=function(a,b){app.result_map={};console.log("sort",a,b);a.forEach(function(a){var c,d;app.result_map[a.gid]=a;d=a.location.lng-b.lng;c=a.location.lat-
b.lat;return a.dist=Math.pow(d,2)+Math.pow(c,2)});a.sort(function(a,b){return a.dist-b.dist});return a.slice(0,25)},a=$("#result_list").empty(),c=$(this),app.offline()?null==t[app.search_keyword]?alert("You are offline now.\nCustom Search is disabled"):app.db.query_place(t[app.search_keyword],function(d){var e;e=function(e){if(null!=e)d=b(d,{lat:e.coords.latitude,lng:e.coords.longitude});else c.one({pageshow:function(){return alert("Cannot get your current location while offline.\nThe results is unsorted and maybe not nearby.\nIn another word, the 1st result does not means the nearest.\nYou need select the place by yourself.")}});
$("#result_addr").text("[Offline] "+app.search_keyword+" ("+d.length+")");a.append(d.map(function(a,b){var c;c=null!=e?'<div style="float:left">'+String.fromCharCode(65+b)+"</div>":"";return'<li><a href="#detail" data-btn-role="result" id="'+a.gid+'">'+c+'<h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join(""));a.listview("refresh");return this};null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){return e(a)},function(){var a;
return e(null!=(a=app.map)?a.lastlatlng:void 0)});return this}):f.getCurPos(function(c){this.setZoom(12);return f.plcsvc.search({location:c,radius:5E3,keyword:app.search_keyword},function(e,h){var j,k,m;if(h===google.maps.places.PlacesServiceStatus.ZERO_RESULTS)alert("Zero Result"),app.back();else if(h===google.maps.places.PlacesServiceStatus.OK){if(e.forEach(function(a){a.gid=a.id;return a.location={lat:a.geometry.location.lat(),lng:a.geometry.location.lng()}}),e=b(e,{lat:c.lat(),lng:c.lng()}),$("#result_addr").text(""+
app.search_keyword+" ("+e.length+")"),a.append(e.map(function(a,b){var c;a.seq=String.fromCharCode(65+b);return'<li><a href="#detail" data-btn-role="result" id="'+a.id+'"><div style="float:left">'+a.seq+'</div><img src="'+(null!=(c=a.icon)?c.replace(/^http:/,""):void 0)+'" class="ui-li-icon"/><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("")),a.listview("refresh"),j=e.reverse().map(function(a){return{position:a.geometry.location,icon:"//www.google.com/mapfiles/marker"+
a.seq+".png",title:a.name}}),j.push({position:c,icon:"//www.google.com/mapfiles/arrow.png",title:"You are here"}),f.setMarkers(j),null==t[app.search_keyword]&&(j=null!=(m=(k=app.user).custom_search_history)?m:k.custom_search_history=[],0===j.length||j[0]!==app.search_keyword))j.unshift(app.search_keyword),app.custom_search_history_refresh()}else alert("Search Error");return this})}),this;app.back()}});z=function(a){var b,c,a=Number(a);c=a.toFixed(1);b=a|0;0<b&&(c+=" "+Array(b+1).join('<img src="res/star.png"/>'));
0.4<a-b&&(c+='<img src="res/halfstar.png"/>');return c};$("#result_list a").live({vclick:function(){return app.selected_place=app.result_map[this.id]}});$("#detail").bind({pagecreate:function(){return $("#apt_cancel").bind({vclick:function(a){a.preventDefault();a.stopPropagation();$("#appointment").dialog("close");return!1}})},pageshow:function(){var a,b,c;a=$("#detial_info").empty();a.height(document.body.clientHeight-a.offset().top-this.fh);console.log("start get detail of",app.selected_place);
window.scrollTop=0;if(app.selected_place)return $('[data-role="navbar"]',this)[app.offline()?"hide":"show"](),c=function(b){var c,h,j,k,m,g;console.log("show detail",b);if(!app.offline())$("#btn_appt")[!b.canappt?"addClass":"removeClass"]("ui-disabled");if(null!=app.map)c=(null!=(k=b.geometry)?k.location:void 0)||new google.maps.LatLng(b.location.lat,b.location.lng),f.setCenter(c),f.setMarkers({position:c}),f.setZoom(15);$("#detail_place").text(b.name);c="Visit its Website";if(null!=b.website){if(/^place:\d+/.test(b.website))b.website=
b.website.replace("place:","http://maps.google.com/maps/place?cid="),c="View on Google Place";if(!/^http/.test(b.website))b.website="http://"+b.website}else b.website=b.url,c="View on Google Place";a.html("<ul><li>"+b.fulladdr+"</li><li>"+b.phone+"</li><li>"+b.gtypes.replace(/_/g," ").toUpperCase()+"</li><li>"+(null!=b.rating?z(b.rating):"(No Rating Yet)")+'</li><li><a href="'+o.attr(b.website)+'" target="_blank">'+c+"</a></li><li>This place "+(b.canappt?"CAN":"CANNOT")+" make Appointment</li>"+(app.offline()?
"<li>You are offline now, neigher Appointment nor Direction is available!</li>":"")+"</ul>");h=null!=(m=(j=app.user).place_search_history)?m:j.place_search_history=[];if(0===h.length||h[0].id!==app.selected_place.id)h.some(function(a,b){return a.id===app.selected_place.id?(h.splice(b,1),!0):!1}),h.unshift({gid:b.gid,reference:app.selected_place.reference,name:b.name,vicinity:b.vicinity,icon:null!=(g=b.icon)?g.replace(/^http:/,""):void 0}),app.place_search_history_refresh();return this},b=app.selected_place,
null!=b.gtypes?c(b):app.db.get_place(b.gid,function(a){if(a.length)return a=a[0],$.extend(b,a),b.geometry={location:google.maps.LatLng(b.location.lat,b.location.lng)},c(b);return app.offline()?(alert("You are offline now, and there is no this place's data on local database"),app.back()):f.plcsvc.getDetails({reference:b.reference},function(a,d){return d===google.maps.places.PlacesServiceStatus.OK?(b.gid=a.id,b.fulladdr=a.formatted_address,b.phone=a.formatted_phone_number,b.gtypes=a.types.join(","),
b.phone=a.phone,b.website=a.website,b.rating=a.rating,b.canappt=!1,c(b)):alert("Get Details Failed")})}),this;app.back()}});$("#direction").bind({pagebeforeshow:function(){var a;if(app.offline())app.back();else return a=$("#direction_panel"),f.getCurPos(function(b,c){return f.dirsvc.route({origin:c,destination:app.selected_place.vicinity,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:!0},function(b,c){return c===google.maps.DirectionsStatus.OK?
(f.dirrdr.setMap(f),f.dirrdr.setPanel(a[0]),f.dirrdr.setDirections(b)):alert("Directions failed: "+c)})}),this},pageshow:function(){var a;a=$("#direction_panel");a.height(document.body.clientHeight-a.offset().top);return this},pagehide:function(){return f.dirrdr.setMap(null)}});console.log(10,"Wilson")}).call(this);
