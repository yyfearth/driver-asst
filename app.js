(function(){function q(a,c,b){function e(a,c){if(!a)return null;var b="",d=null;if(a.childNodes&&0<a.childNodes.length)for(var g=0;g<a.childNodes.length;g++){var h=a.childNodes[g],j=h.nodeType,i=h.localName||h.nodeName||"",k=h.text||h.nodeValue||"";if(8!=j)if(3==j||4==j||!i)b+=k.replace(/^\s+|\s+$/g,"");else if(d=d||{},d[i]){if(!(d[i]instanceof Array)||!d[i].length)d[i]=[d[i]];d[i].push(e(h,!0))}else d[i]=e(h,!1)}if(a.attributes&&!r&&0<a.attributes.length){d=d||{};for(h=0;h<a.attributes.length;h++)i=
a.attributes[h],j=i.name||"",i=i.value,d[j]?(!(d[j]instanceof Array)&&d[j].length&&(d[j]=[d[j]]),d[j].push(i)):d[j]=i}if(d){if(""!=b){h=new String(b);for(g in d)h[g]=d[g];d=h}if(b=d.text?("object"==typeof d.text?d.text:[d.text||""]).concat([b]):b)d.text=b;b=""}d=d||b;if(f){b&&(d={});if(b=d.text||b||"")d.text=b;!c&&!(d instanceof Array)&&(d=[d])}return d}var f=c,r=b;if(!a)return{};"string"==typeof a&&(a=s(a));if(a.nodeType){if(3==a.nodeType||4==a.nodeType)return a.nodeValue;a=9==a.nodeType?a.documentElement:
a;c=e(a,!0);a=a=null;return c}}function s(a){var c;try{var b=new DOMParser;b.async=!1;c=b.parseFromString(a,"text/xml")}catch(e){throw Error("Error parsing XML string");}return c}var k,n,o,f,l,p,m,g=function(a,c){return function(){return a.apply(c,arguments)}};window.app={back:function(){return history.go(-1)}};location.hash="#home";$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();l=
$(document.querySelectorAll('[data-role="map"]'));l.add("#map").height(Math.round(0.35*document.body.clientHeight));$("#home").one({pageshow:function(){return f.el.offset($("#home_map").offset())}});f=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}});m=new google.maps.places.PlacesService(f);o=new google.maps.Geocoder;n=new google.maps.DirectionsService;k=new google.maps.DirectionsRenderer;
p=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,-122.728271),new google.maps.LatLng(37.247821,-121.552734));(function(){this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{move:g(function(){return this},this),setMarkers:g(function(a){console.log("markers",a);a?$.isArray(a)||(a=[a]):a=null;null!=this.markers&&this.markers.forEach(function(a){return a.setMap(null)});this.markers=null!=a?a.map(function(a){a.map=f;return new google.maps.Marker(a)}):null;
return this},this),getCurPos:g(function(a,c){null==c&&(c=a,a=!0);null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(g(function(b){var e;e=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);console.log("curlatlng",e);if(!e.equals(this.getCenter()))e.changed=!0;return a?(this.setMarkers(null),this.setCenter(e),l.each(g(function(a,b){return $(b).css("background-image","url('https://maps.googleapis.com/maps/api/staticmap?center="+e.lat()+","+e.lng()+"&zoom="+($(b).attr("data-map-zoom")||
15)+"&size="+$(window).width()+"x"+this.el.height()+"&maptype=roadmap&format=png8&sensor=true')")},this)),o.geocode({latLng:e},g(function(a,b){var f;b===google.maps.GeocoderStatus.OK?c.call(this,e,null!=(f=a[0])?f.formatted_address:void 0):alert("Geocoder failed due to: "+b+"\n App terminated!");return this.setCenter(e)},this))):c.call(this,e)},this),function(){return alert("App cannot run without geo location!")});return this},this)})}).call(f);$('[data-role="page"]').bind({pagebeforeshow:function(){return f.el.css("opacity",
0).show()},pageshow:function(){return f.el[$(this).hasClass("has-map")?"show":"hide"]().css("opacity",1)}});$("#home").bind({pageshow:function(){},pagebeforeshow:function(){if(!$("#map",this).length)return console.log("home pageshow"),f.getCurPos(function(a,c){$("#home_addr").text(c);this.setZoom(15);this.setMarkers({position:a});return this.move("home")}),this},pagehide:function(){}});$.ajax({url:"/gapi?weather=san+jose,ca",dataType:"xml",success:function(a){var c,b;b=q(a);a=b.weather.current_conditions;
console.log("w:",b);c=function(a){return"https://www.google.com"+a.icon.data};$("#weather").html('<img src="'+c(a)+'"/>'+a.temp_f.data+"\u00b0F "+a.condition.data+" ").append(b.weather.forecast_conditions.map(function(a){return'<img src="'+c(a)+'"/>'+a.day_of_week.data+" "+a.high.data+"/"+a.low.data+"\u00b0F "}).join(""));return this},error:function(a){return console.log("get weather failed",a)}});try{console.log(localStorage.custom_search_history);if(null!=localStorage.custom_search_history)app.history=
JSON.parse(localStorage.custom_search_history);if(!$.isArray(app.history))app.history=[]}catch(t){console.log(t),app.history=[]}finally{app.history.refresh=g(function(){$("#history_list li:gt(0)").remove();return app.history.length?$("#history_list_header").after(app.history.map(function(a){return'<li><a href="#result" data-btn-role="search">'+a+"</a></li>"}).join("")):$("#history_list_header").after('<li data-role="list-divider" class="ui-body-c list-none">(None)</li>')},this)}$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=
$(this).text();console.log("vclick",app.search_keyword);return this}});$("#search_history").bind({pagecreate:function(){this.created=!0;app.history.refresh();return new google.maps.places.Autocomplete($("#input_search")[0],{bounds:p,types:["establishment"]})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#history_list").listview("refresh")});$("#custom_search_form").submit(function(){var a,c;a=$("#input_search");(c=$.trim(a.val()))?(app.search_keyword=
c,$.mobile.changePage("#result"),console.log("vclick",app.history.search_keyword)):a.focus().val("");return!1});window.onbeforeunload=function(){localStorage.custom_search_history=JSON.stringify(app.history)};$("#result").bind({pageshow:function(){var a;console.log("search for",app.search_keyword);if(app.search_keyword)return a=$("#result_list").empty(),f.getCurPos(function(c){this.setZoom(12);this.move("result");return m.search({location:c,radius:5E3,keyword:app.search_keyword},function(b,e){var g;
e===google.maps.places.PlacesServiceStatus.ZERO_RESULTS?(alert("Zero Result"),app.back()):e===google.maps.places.PlacesServiceStatus.OK?($("#result_addr").text(""+app.search_keyword+" ("+b.length+")"),a.height(document.body.clientHeight-a.offset().top),console.log("search result",b),app.result_map={},b.forEach(function(a){var b,e;app.result_map[a.id]=a;a=a.geometry;e=a.location.lng()-c.lng();b=a.location.lat()-c.lat();return a.dist=Math.pow(e,2)+Math.pow(b,2)}),b.sort(function(a,b){return a.geometry.dist-
b.geometry.dist}),b=b.slice(0,25),a.append(b.map(function(a,b){a.seq=String.fromCharCode(65+b);return'<li><a href="#detail" data-btn-role="result" id="'+a.id+'"><div style="float:left">'+a.seq+'</div><img src="'+a.icon+'" class="ui-li-icon"><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("")),g=b.reverse().map(function(a){return{position:a.geometry.location,icon:"https://www.google.com/mapfiles/marker"+a.seq+".png",title:a.name}}),a.listview("refresh"),
g.push({position:c,icon:"https://www.google.com/mapfiles/arrow.png",title:"You are here"}),f.setMarkers(g),app.history[0]!==app.search_keyword&&(app.history.unshift(app.search_keyword),app.history.refresh())):alert("Search Error");return this})}),this;app.back()}});$("#result_list a").live({vclick:function(){console.log(this.id);return app.selected_place=app.result_map[this.id]}});$("#detail").bind({pageshow:function(){console.log("detailof",app.selected_place);if(app.selected_place)return $("#apt_cancel").bind({vclick:function(){return $("#appointment").dialog("close")}}),
m.getDetails({reference:app.selected_place.reference},function(a,c){if(c===google.maps.places.PlacesServiceStatus.OK)return f.setCenter(a.geometry.location),f.setMarkers({position:a.geometry.location}),f.setZoom(15),$("#detail_place").text(a.name),$("#detial_info").text(JSON.stringify(a,null,"  ")),console.log(a)});app.back()}});$("#direction").bind({pageshow:function(){return f.getCurPos(function(a,c){this.setZoom(14);return n.route({origin:c,destination:app.selected_place.vicinity,travelMode:google.maps.DirectionsTravelMode.DRIVING,
unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:!0},function(a,c){return c===google.maps.DirectionsStatus.OK?(k.setMap(f),k.setPanel($("#direction_panel")[0]),k.setDirections(a)):alert("Directions failed: "+c)})})},pagehide:function(){return k.setMap(null)}});console.log(1)}).call(this);
